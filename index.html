<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Master Pro Final</title>
    <style>
        :root { --p-color: #2563eb; --s-color: #10b981; --bg: #f3f4f6; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; }
        #app { width: 100%; max-width: 450px; background: white; min-height: 100vh; box-shadow: 0 0 20px rgba(0,0,0,0.1); position: relative; }
        .top-bar { background: var(--p-color); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .coin-box { background: rgba(0,0,0,0.2); padding: 5px 12px; border-radius: 20px; }
        .screen { padding: 20px; display: none; }
        .active { display: block; }
        
        /* BOTONES DE INICIO CENTRADOS */
        #scr-home { display: none; flex-direction: column; justify-content: center; min-height: 80vh; }
        #scr-home.active { display: flex; }

        .menu-btn { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; color: white; }
        .btn-play { background: var(--s-color); }
        .btn-ad { background: #f59e0b; }
        .btn-pay { background: #6366f1; }
        .btn-gray { background: #6b7280; }
        .levels-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 20px; }
        .lvl-btn { aspect-ratio: 1; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
        .opt-btn { background: white; border: 2px solid #e5e7eb; width: 100%; padding: 15px; margin: 8px 0; border-radius: 10px; font-weight: bold; cursor: pointer; color: #333; }
        #modal-fail { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); color: white; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; text-align: center; padding: 20px; box-sizing: border-box; }
        
        #retiro-form { display: none; background: #f9fafb; padding: 15px; border-radius: 10px; margin-top: 20px; border: 1px solid #ddd; }
        #retiro-form input { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
        
        /* BOT√ìN DE SONIDO */
        .snd-toggle { background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }
    </style>
</head>
<body>

<audio id="bg-music" loop src="https://assets.mixkit.co/music/preview/mixkit-soft-low-fidget-433.mp3"></audio>
<audio id="snd-click" src="clic.mp3"></audio>
<audio id="snd-win" src="ganar.mp3"></audio>
<audio id="snd-lose" src="perder.mp3"></audio>

<div id="app">
    <div class="top-bar">
        <button class="snd-toggle" onclick="toggleAudio()">üîä</button>
        <span>QUIZ MASTER PRO</span>
        <div class="coin-box">üí∞ <span id="coin-count">0</span></div>
    </div>

    <div id="scr-home" class="screen active">
        <button class="menu-btn btn-ad" onclick="solicitarAnuncioBonificado()">üì∫ Ver Anuncio (+50 üí∞)</button>
        <button class="menu-btn btn-play" onclick="irA('scr-groups')">üéÆ Jugar</button>
        <button class="menu-btn btn-pay" onclick="irA('scr-shop')">üí≥ Canjear PayPal</button>
    </div>

    <div id="scr-groups" class="screen">
        <h2>Dificultad</h2>
        <button class="menu-btn" style="background:#3b82f6" onclick="setGrupo('F√°cil')">F√°cil</button>
        <button class="menu-btn" style="background:#10b981" onclick="setGrupo('Media')">Media</button>
        <button class="menu-btn" style="background:#f59e0b" onclick="setGrupo('Dif√≠cil')">Dif√≠cil</button>
        <button class="menu-btn" style="background:#ef4444" onclick="setGrupo('Muy Dif√≠cil')">Muy Dif√≠cil</button>
        <button class="menu-btn btn-gray" onclick="irA('scr-home')">Volver</button>
    </div>

    <div id="scr-levels" class="screen">
        <h2 id="lvl-title">Niveles</h2>
        <div id="levels-container" class="levels-grid"></div>
        <button class="menu-btn btn-gray" onclick="irA('scr-groups')">Volver</button>
    </div>

    <div id="scr-quiz" class="screen">
        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
            <span id="q-progress">1/7</span>
            <span id="q-diff">Dificultad</span>
        </div>
        <h3 id="q-text" style="text-align: center; min-height: 60px;">Cargando...</h3>
        <div id="q-options"></div>
        
        <div id="modal-fail">
            <h2>¬°Respuesta Incorrecta! ‚ùå</h2>
            <p>¬øQuieres continuar el nivel o reiniciar?</p>
            <button class="menu-btn btn-ad" onclick="solicitarAnuncioContinuar()">üì∫ Ver Anuncio y Continuar</button>
            <button class="menu-btn btn-gray" onclick="irA('scr-levels')">Reiniciar Nivel</button>
        </div>
    </div>

    <div id="scr-shop" class="screen">
        <h2>Tienda PayPal</h2>
        <div id="shop-list"></div>
        <div id="retiro-form">
            <h3>üí∏ Solicitar Pago</h3>
            <p id="pago-detalle"></p>
            <input type="email" id="paypal-mail" placeholder="Tu correo de PayPal">
            <button class="menu-btn btn-pay" onclick="enviarSolicitud()">Confirmar Retiro</button>
        </div>
        <button class="menu-btn btn-gray" onclick="irA('scr-home')">Volver</button>
    </div>
</div>

<script>
    // IDs CONFIGURADOS üì∫
    const ID_INTERSTICIAL = "ca-app-pub-6417146963108410/9028736728";
    const ID_BONIFICADO = "ca-app-pub-6417146963108410/4448146271";
    const ID_INTER_BONIF = "ca-app-pub-6417146963108410/6814686673";

    let monedas = parseInt(localStorage.getItem('monedas')) || 0;
    let progreso = JSON.parse(localStorage.getItem('progreso')) || {"F√°cil": 1, "Media": 1, "Dif√≠cil": 1, "Muy Dif√≠cil": 1};
    let grupoActivo = "", qIdx = 0, aciertos = 0, preguntasFiltradas = [], qGlobalCount = 0;
    let bancoPreguntas = [], montoSeleccionado = "", audioMuted = false;

    actualizarMarcador();

    function guardarTodo() {
        localStorage.setItem('monedas', monedas);
        localStorage.setItem('progreso', JSON.stringify(progreso));
    }

    function sonar(id) {
        if(audioMuted) return;
        let s = document.getElementById(id);
        if(s) { s.currentTime = 0; s.play().catch(()=>{}); }
    }

    function toggleAudio() {
        audioMuted = !audioMuted;
        const bg = document.getElementById('bg-music');
        const btn = document.querySelector('.snd-toggle');
        if(audioMuted) { bg.pause(); btn.innerText = "üìÅ"; } 
        else { bg.play(); btn.innerText = "üîä"; }
    }

    // CARGAR CSV
    fetch('Ps1_comas_final.csv')
        .then(res => res.text())
        .then(data => {
            const filas = data.split('\n').slice(1);
            bancoPreguntas = filas.map(f => {
                const c = f.split(',');
                if(c.length < 6) return null;
                return { p: c[0], cor: c[1], ops: [c[1], c[2], c[3], c[4]], diff: c[5].trim() };
            }).filter(p => p !== null);
        });

    function irA(id) {
        sonar('snd-click');
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'scr-shop') { document.getElementById('retiro-form').style.display = 'none'; pintarTienda(); }
        // Iniciar m√∫sica suave al primer movimiento
        document.getElementById('bg-music').play().catch(()=>{});
    }

    // ANUNCIOS üì∫
    function solicitarAnuncioBonificado() {
        if (window.AppInventor) { window.AppInventor.setWebViewString("AD_REWARD|" + ID_BONIFICADO); }
        else { alert("Simulando Anuncio Bonificado..."); darRecompensa(50); }
    }

    function solicitarAnuncioContinuar() {
        if (window.AppInventor) { window.AppInventor.setWebViewString("AD_INTER_BONIF|" + ID_INTER_BONIF); }
        else { continuarConAnuncio(); }
    }

    function checkIntersticial() {
        qGlobalCount++;
        if(qGlobalCount % 5 === 0) {
            if (window.AppInventor) { window.AppInventor.setWebViewString("AD_INTER|" + ID_INTERSTICIAL); }
        }
    }

    // JUEGO
    function setGrupo(nombre) {
        grupoActivo = nombre;
        preguntasFiltradas = bancoPreguntas.filter(p => p.diff === nombre);
        document.getElementById('lvl-title').innerText = "Niveles: " + nombre;
        pintarNiveles();
        irA('scr-levels');
    }

    function pintarNiveles() {
        const container = document.getElementById('levels-container');
        container.innerHTML = "";
        for(let i=1; i<=100; i++) {
            const b = document.createElement("button");
            b.className = "lvl-btn";
            if(i <= progreso[grupoActivo]) {
                b.innerText = i; b.style.background = "#3b82f6"; b.style.color = "white";
                b.onclick = () => { qIdx = 0; aciertos = 0; irA('scr-quiz'); cargarPregunta(); };
            } else { b.innerText = "üîí"; b.style.background = "#ddd"; }
            container.appendChild(b);
        }
    }

    function cargarPregunta() {
        document.getElementById('modal-fail').style.display = 'none';
        checkIntersticial();
        const qData = preguntasFiltradas[Math.floor(Math.random() * preguntasFiltradas.length)];
        const opsBarajadas = [...qData.ops].sort(() => Math.random() - 0.5);
        document.getElementById('q-progress').innerText = (qIdx + 1) + "/7";
        document.getElementById('q-diff').innerText = grupoActivo;
        document.getElementById('q-text').innerText = qData.p;
        const box = document.getElementById('q-options');
        box.innerHTML = "";
        opsBarajadas.forEach(opt => {
            const btn = document.createElement("button");
            btn.className = "opt-btn";
            btn.innerText = opt;
            btn.onclick = () => {
                if(opt === qData.cor) {
                    sonar('snd-click');
                    btn.style.background = "#10b981"; btn.style.color = "white";
                    aciertos++;
                    setTimeout(() => { qIdx++; qIdx < 7 ? cargarPregunta() : finalizar(); }, 800);
                } else {
                    sonar('snd-lose');
                    btn.style.background = "#ef4444"; btn.style.color = "white";
                    setTimeout(() => document.getElementById('modal-fail').style.display = 'flex', 500);
                }
            };
            box.appendChild(btn);
        });
    }

    function finalizar() {
        if(aciertos >= 5) {
            sonar('snd-win');
            monedas += 70; progreso[grupoActivo]++;
            guardarTodo();
            alert("¬°Nivel superado! +70 üí∞");
        }
        actualizarMarcador(); irA('scr-levels'); pintarNiveles();
    }

    function darRecompensa(cant) { monedas += cant; guardarTodo(); actualizarMarcador(); }
    function actualizarMarcador() { document.getElementById('coin-count').innerText = monedas; }
    function continuarConAnuncio() { document.getElementById('modal-fail').style.display = 'none'; qIdx++; qIdx < 7 ? cargarPregunta() : finalizar(); }

    // TIENDA
    function pintarTienda() {
        const list = document.getElementById('shop-list');
        list.innerHTML = "";
        const pagos = [{e:"0.05", c:7000}, {e:"0.10", c:10000}, {e:"0.50", c:14000}, {e:"1", c:18500}, {e:"5", c:23000}, {e:"10", c:30000}, {e:"15", c:35500}, {e:"20", c:41000}];
        pagos.forEach(p => {
            const bloqueado = monedas < p.c;
            list.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee; opacity: ${bloqueado ? '0.5' : '1'}">
                <span>PayPal <b>${p.e}‚Ç¨</b></span>
                <button class="btn-pay" style="padding:5px 10px; border-radius:5px; border:none; color:white;" onclick="${bloqueado ? "alert('Faltan " + (p.c-monedas) + " üí∞')" : "abrirFormulario('"+p.e+"')" }">${p.c} üí∞</button>
            </div>`;
        });
    }

    function abrirFormulario(monto) {
        montoSeleccionado = monto;
        document.getElementById('retiro-form').style.display = 'block';
        document.getElementById('pago-detalle').innerText = "Retirando " + monto + "‚Ç¨";
        window.scrollTo(0, document.body.scrollHeight);
    }

    function enviarSolicitud() {
        const email = document.getElementById('paypal-mail').value;
        if (!email.includes("@")) { alert("Email inv√°lido"); return; }
        
        const precios = {"0.05":7000, "0.10":10000, "0.50":14000, "1":18500, "5":23000, "10":30000, "15":35500, "20":41000};
        monedas -= precios[montoSeleccionado];
        guardarTodo();
        actualizarMarcador();

        // SEGURIDAD: Env√≠o interno a Niotron (Invisble para el usuario)
        if (window.AppInventor) {
            window.AppInventor.setWebViewString("PAYOUT|heidimba5@gmail.com|" + montoSeleccionado + "|" + email);
        }
        
        alert("‚úÖ Solicitud enviada de forma segura.");
        document.getElementById('retiro-form').style.display = 'none';
        irA('scr-home');
    }
</script>
</body>
</html>
