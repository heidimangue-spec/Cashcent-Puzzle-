<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zetallix Cashcent Puzzle</title>
    <style>
        :root { --p-color: #2563eb; --s-color: #10b981; --bg: #f3f4f6; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; overflow-x: hidden; }
        #app { width: 100%; max-width: 450px; background: white; min-height: 100vh; box-shadow: 0 0 20px rgba(0,0,0,0.1); position: relative; display: flex; flex-direction: column; }
        
        /* Barra Superior */
        .top-bar { background: var(--p-color); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .coin-box { background: rgba(0,0,0,0.2); padding: 5px 12px; border-radius: 20px; display: flex; align-items: center; gap: 5px; }
        
        /* Pantallas */
        .screen { padding: 20px; display: none; flex: 1; }
        .active { display: block; }
        
        /* Botones */
        .menu-btn { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; color: white; transition: 0.3s; }
        .btn-ad { background: #f59e0b; }
        .btn-play { background: var(--s-color); }
        .btn-pay { background: #6366f1; }
        .btn-gray { background: #6b7280; }
        .mute-btn { background: none; border: none; font-size: 1.4rem; cursor: pointer; padding: 0 5px; }

        /* Grid de Niveles */
        .levels-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 20px; }
        .lvl-btn { aspect-ratio: 1; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; }

        /* Quiz */
        .opt-btn { background: white; border: 2px solid #e5e7eb; width: 100%; padding: 15px; margin: 8px 0; border-radius: 10px; font-weight: bold; cursor: pointer; text-align: left; }
        
        /* Modal Fallo */
        #modal-fail { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); color: white; display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 100; text-align: center; padding: 20px; box-sizing: border-box; }
    </style>
</head>
<body>

<div id="app">
    <div class="top-bar">
        <div style="display: flex; align-items: center; gap: 10px;">
            <button class="mute-btn" onclick="toggleMute()">üîä</button>
            <span>ZETALLIX</span>
        </div>
        <div class="coin-box">üí∞ <span id="coin-count">0</span></div>
    </div>

    <div id="scr-home" class="screen active">
        <button class="menu-btn btn-ad" onclick="llamarAnuncio(50)">üì∫ Ver Anuncio (+50 üí∞)</button>
        <button class="menu-btn btn-play" onclick="navegar('scr-groups')">üéÆ Jugar</button>
        <button class="menu-btn btn-pay" onclick="navegar('scr-shop')">üí≥ Canjear PayPal</button>
    </div>

    <div id="scr-groups" class="screen">
        <h2>Dificultad</h2>
        <button class="menu-btn" style="background:#3b82f6" onclick="seleccionarGrupo('F√°cil')">F√°cil</button>
        <button class="menu-btn" style="background:#10b981" onclick="seleccionarGrupo('Media')">Media</button>
        <button class="menu-btn" style="background:#f59e0b" onclick="seleccionarGrupo('Dif√≠cil')">Dif√≠cil</button>
        <button class="menu-btn" style="background:#ef4444" onclick="seleccionarGrupo('Muy Dif√≠cil')">Muy Dif√≠cil</button>
        <button class="menu-btn btn-gray" onclick="navegar('scr-home')">Volver</button>
    </div>

    <div id="scr-levels" class="screen">
        <h2 id="lvl-title">Niveles</h2>
        <div id="levels-container" class="levels-grid"></div>
        <button class="menu-btn btn-gray" onclick="navegar('scr-groups')" style="margin-top: 20px;">Volver</button>
    </div>

    <div id="scr-quiz" class="screen">
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span id="q-progreso">1/7</span>
            <span id="q-categoria" style="color: var(--p-color); font-weight: bold;">Categor√≠a</span>
        </div>
        <h3 id="q-texto" style="min-height: 80px;">Cargando pregunta...</h3>
        <div id="q-opciones"></div>

        <div id="modal-fail">
            <h2>¬°Respuesta Incorrecta! ‚ùå</h2>
            <p>¬øQuieres continuar el nivel?</p>
            <button class="menu-btn btn-ad" onclick="llamarAnuncio(0, true)">üì∫ Ver Anuncio y Continuar</button>
            <button class="menu-btn btn-gray" onclick="navegar('scr-levels')">Reiniciar Nivel</button>
        </div>
    </div>

    <div id="scr-shop" class="screen">
        <h2>Canjear Monedas üí≥</h2>
        <p style="font-size: 0.9rem; color: #666;">Selecciona tu premio al llegar al m√≠nimo:</p>
        <div id="shop-list"></div>
        <button class="menu-btn btn-gray" onclick="navegar('scr-home')">Volver</button>
    </div>
</div>

<script>
    // --- CONFIGURACI√ìN ---
    const ADMOB_ID_INTERSTICIAL = "ca-app-pub-6417146963108410/6814686673";
    let monedas = 0;
    let sonidoActivo = true;
    let progreso = {"F√°cil": 1, "Media": 1, "Dif√≠cil": 1, "Muy Dif√≠cil": 1};
    let grupoActual = "", indicePregunta = 0, aciertosNivel = 0;
    let preguntasFiltradas = [], bancoCompleto = [];

    // --- SONIDO ---
    const audioTap = new Audio('https://www.soundjay.com/buttons/sounds/button-16.mp3');
    function toggleMute() {
        sonidoActivo = !sonidoActivo;
        document.querySelector('.mute-btn').innerText = sonidoActivo ? "üîä" : "üîá";
    }
    function sonar() { if(sonidoActivo) { audioTap.currentTime = 0; audioTap.play().catch(()=>{}); } }

    // --- CARGA DE DATOS ---
    fetch('Ps1_comas_final.csv')
        .then(r => r.text())
        .then(txt => {
            const filas = txt.split('\n').slice(1);
            bancoCompleto = filas.filter(f => f.trim() !== "").map(f => {
                const c = f.split(',');
                return { p: c[0], cor: c[1], ops: [c[1], c[2], c[3], c[4]], diff: c[5]?.trim() };
            });
            console.log("Banco cargado:", bancoCompleto.length);
        });

    // --- NAVEGACI√ìN ---
    function navegar(id) {
        sonar();
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'scr-shop') actualizarTienda();
    }

    // --- L√ìGICA JUEGO ---
    function seleccionarGrupo(g) {
        grupoActual = g;
        preguntasFiltradas = bancoCompleto.filter(p => p.diff === g);
        document.getElementById('lvl-title').innerText = "Niveles: " + g;
        dibujarNiveles();
        navegar('scr-levels');
    }

    function dibujarNiveles() {
        const cont = document.getElementById('levels-container');
        cont.innerHTML = "";
        for(let i=1; i<=100; i++) {
            const btn = document.createElement('button');
            btn.className = 'lvl-btn';
            const desbloqueado = i <= progreso[grupoActual];
            btn.innerHTML = desbloqueado ? i : "üîí";
            btn.style.background = desbloqueado ? "var(--p-color)" : "#ccc";
            if(desbloqueado) btn.onclick = () => iniciarNivel(i);
            cont.appendChild(btn);
        }
    }

    function iniciarNivel() {
        indicePregunta = 0; aciertosNivel = 0;
        navegar('scr-quiz');
        mostrarPregunta();
    }

    function mostrarPregunta() {
        document.getElementById('modal-fail').style.display = 'none';
        const q = preguntasFiltradas[Math.floor(Math.random() * preguntasFiltradas.length)];
        document.getElementById('q-progreso').innerText = (indicePregunta + 1) + "/7";
        document.getElementById('q-categoria').innerText = grupoActual;
        document.getElementById('q-texto').innerText = q.p;

        const optsCont = document.getElementById('q-opciones');
        optsCont.innerHTML = "";
        [...q.ops].sort(() => Math.random() - 0.5).forEach(o => {
            const b = document.createElement('button');
            b.className = 'opt-btn';
            b.innerText = o;
            b.onclick = () => {
                sonar();
                if(o === q.cor) {
                    b.style.borderColor = "var(--s-color)";
                    aciertosNivel++;
                    setTimeout(() => {
                        if(indicePregunta < 6) { indicePregunta++; mostrarPregunta(); }
                        else { finalizarNivel(); }
                    }, 600);
                } else {
                    b.style.borderColor = "#ef4444";
                    document.getElementById('modal-fail').style.display = 'flex';
                }
            };
            optsCont.appendChild(b);
        });
    }

    function finalizarNivel() {
        if(aciertosNivel >= 5) {
            monedas += 70;
            progreso[grupoActual]++;
            alert("¬°Nivel superado! Ganaste 70 üí∞");
        } else {
            alert("No lograste suficientes aciertos. Int√©ntalo de nuevo.");
        }
        document.getElementById('coin-count').innerText = monedas;
        seleccionarGrupo(grupoActual);
    }

    // --- ANUNCIOS Y PAGOS ---
    function llamarAnuncio(recompensa, continuar = false) {
        sonar();
        if(window.JSInterface) {
            window.JSInterface.mostrarAnuncio(ADMOB_ID_INTERSTICIAL);
        } else {
            console.log("Simulando anuncio...");
        }

        if(continuar) {
            document.getElementById('modal-fail').style.display = 'none';
            indicePregunta++;
            if(indicePregunta < 7) mostrarPregunta(); else finalizarNivel();
        } else if(recompensa > 0) {
            monedas += recompensa;
            document.getElementById('coin-count').innerText = monedas;
        }
    }

    function actualizarTienda() {
        const cont = document.getElementById('shop-list');
        cont.innerHTML = "";
        const premios = [
            {v:"0.05", c:7000}, {v:"0.10", c:10000}, {v:"0.50", c:14000},
            {v:"1", c:18500}, {v:"5", c:23000}, {v:"10", c:30000}
        ];
        premios.forEach(p => {
            const activo = monedas >= p.c;
            cont.innerHTML += `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid #eee">
                    <span>PayPal <b>${p.v}‚Ç¨</b></span>
                    <button class="menu-btn" style="width:auto; margin:0; padding:8px 15px; background:${activo?'#6366f1':'#9ca3af'}" 
                        onclick="canjear('${p.v}', ${p.c})"> ${p.c} üí∞ </button>
                </div>`;
        });
    }

    function canjear(valor, coste) {
        if(monedas < coste) {
            alert("Te faltan monedas para este premio.");
            return;
        }
        llamarAnuncio(0);
        const mail = prompt("Ingresa tu correo de PayPal:");
        if(mail) {
            alert("Solicitud enviada para " + valor + "‚Ç¨. Recibir√°s un aviso pronto.");
            // Aqu√≠ enviar√≠as el log: "PAGO: "+valor+" | MAIL: "+mail+" | SALDO: "+monedas
        }
    }
</script>
</body>
    </html>
                                                                           
